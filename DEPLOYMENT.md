# ECS/Fargate RabbitMQ ë°°í¬ ê°€ì´ë“œ

ì´ ê°€ì´ë“œëŠ” ê¸°ì¡´ Docker Compose í™˜ê²½ì—ì„œ AWS ECS/Fargateë¡œ RabbitMQ í´ëŸ¬ìŠ¤í„°ë¥¼ ë§ˆì´ê·¸ë ˆì´ì…˜í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Internet                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ALB (Public)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ECS Fargate Cluster                            â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ RabbitMQ    â”‚  â”‚ RabbitMQ    â”‚  â”‚ RabbitMQ    â”‚         â”‚
â”‚  â”‚ Node 1      â”‚  â”‚ Node 2      â”‚  â”‚ Node 3      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Chat API    â”‚  â”‚ Chat API    â”‚                          â”‚
â”‚  â”‚ Service     â”‚  â”‚ Service     â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ Web         â”‚  â”‚ Web         â”‚                          â”‚
â”‚  â”‚ Service     â”‚  â”‚ Service     â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 EFS (Data Storage)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ ì‚¬ì „ ìš”êµ¬ì‚¬í•­

### 1. AWS CLI ì„¤ì •

```bash
aws configure
```

### 2. Terraform ì„¤ì¹˜

```bash
# macOS
brew install terraform

# ë˜ëŠ” ì§ì ‘ ë‹¤ìš´ë¡œë“œ
# https://www.terraform.io/downloads.html
```

### 3. í•„ìš”í•œ ê¶Œí•œ

- ECS ê´€ë ¨ ê¶Œí•œ
- VPC ë° ë„¤íŠ¸ì›Œí‚¹ ê¶Œí•œ
- IAM ê¶Œí•œ
- EFS ê¶Œí•œ
- CloudWatch ê¶Œí•œ
- SSM ê¶Œí•œ

## ğŸš€ ë°°í¬ ë‹¨ê³„

### 1ë‹¨ê³„: ì¸í”„ë¼ ì„¤ì •

1. **terraform.tfvars íŒŒì¼ ìƒì„±**

```bash
cp terraform.tfvars.example terraform.tfvars
# ì‹¤ì œ ê°’ìœ¼ë¡œ ìˆ˜ì •
```

2. **Terraform ì´ˆê¸°í™” ë° ì ìš©**

```bash
cd terraform
terraform init
terraform plan
terraform apply
```

### 2ë‹¨ê³„: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ì¤€ë¹„

ê¸°ì¡´ Docker ì´ë¯¸ì§€ë“¤ì´ ECRì— ìˆëŠ”ì§€ í™•ì¸:

- `859727769026.dkr.ecr.ap-northeast-2.amazonaws.com/fishing-booking-chat-api:latest`
- `859727769026.dkr.ecr.ap-northeast-2.amazonaws.com/fishing-booking-web:latest`

### 3ë‹¨ê³„: ECS í´ëŸ¬ìŠ¤í„° ë°°í¬

Terraform applyê°€ ì™„ë£Œë˜ë©´ ë‹¤ìŒ ë¦¬ì†ŒìŠ¤ë“¤ì´ ìƒì„±ë©ë‹ˆë‹¤:

- ECS í´ëŸ¬ìŠ¤í„°
- RabbitMQ ì„œë¹„ìŠ¤ (3ê°œ ì¸ìŠ¤í„´ìŠ¤)
- Chat API ì„œë¹„ìŠ¤ (2ê°œ ì¸ìŠ¤í„´ìŠ¤)
- Web ì„œë¹„ìŠ¤ (2ê°œ ì¸ìŠ¤í„´ìŠ¤)
- ALB ë° íƒ€ê²Ÿ ê·¸ë£¹
- EFS íŒŒì¼ ì‹œìŠ¤í…œ

### 4ë‹¨ê³„: RabbitMQ í´ëŸ¬ìŠ¤í„° êµ¬ì„±

```bash
# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
chmod +x scripts/configure-rabbitmq-cluster.sh

# RabbitMQ í´ëŸ¬ìŠ¤í„° êµ¬ì„±
./scripts/configure-rabbitmq-cluster.sh
```

### 5ë‹¨ê³„: ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸

```bash
# ECS ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
aws ecs describe-services \
  --cluster fishing-chat-cluster \
  --services fishing-chat-rabbitmq fishing-chat-api fishing-chat-web \
  --region ap-northeast-2

# ALB ìƒíƒœ í™•ì¸
aws elbv2 describe-load-balancers \
  --names fishing-chat-alb \
  --region ap-northeast-2
```

## ğŸ”§ êµ¬ì„± ìƒì„¸

### RabbitMQ í´ëŸ¬ìŠ¤í„° ì„¤ì •

- **ê³ ê°€ìš©ì„±**: 3ë…¸ë“œ í´ëŸ¬ìŠ¤í„°ë¡œ êµ¬ì„±
- **ë°ì´í„° ì§€ì†ì„±**: EFSë¥¼ í†µí•œ ì˜êµ¬ ìŠ¤í† ë¦¬ì§€
- **ì„œë¹„ìŠ¤ ë””ìŠ¤ì»¤ë²„ë¦¬**: `rabbitmq.fishing-chat.local`
- **ê´€ë¦¬ UI**: ê° ë…¸ë“œì˜ 15672 í¬íŠ¸

### ë„¤íŠ¸ì›Œí‚¹

- **Service Discovery**: AWS Cloud Map ì‚¬ìš©
- **Load Balancing**: ALBë¥¼ í†µí•œ íŠ¸ë˜í”½ ë¶„ì‚°
- **Security Groups**: ìµœì†Œ ê¶Œí•œ ì›ì¹™ ì ìš©

### ëª¨ë‹ˆí„°ë§

- **CloudWatch Logs**: ëª¨ë“  ì„œë¹„ìŠ¤ ë¡œê·¸ ìˆ˜ì§‘
- **Container Insights**: ECS í´ëŸ¬ìŠ¤í„° ëª¨ë‹ˆí„°ë§
- **Health Checks**: ê° ì„œë¹„ìŠ¤ë³„ í—¬ìŠ¤ì²´í¬ êµ¬ì„±

## ğŸ’° ì˜ˆìƒ ë¹„ìš© (ì›”)

| ë¦¬ì†ŒìŠ¤             | ìˆ˜ëŸ‰          | ì˜ˆìƒ ë¹„ìš© |
| ------------------ | ------------- | --------- |
| Fargate (RabbitMQ) | 3 x 1vCPU/2GB | ~$45      |
| Fargate (Chat API) | 2 x 2vCPU/4GB | ~$60      |
| Fargate (Web)      | 2 x 1vCPU/2GB | ~$30      |
| EFS                | 20GB          | ~$6       |
| ALB                | 1ê°œ           | ~$23      |
| **ì´í•©**           |               | **~$164** |

_ë¹„ìš©ì€ ap-northeast-2 ê¸°ì¤€ì´ë©° ì‹¤ì œ ì‚¬ìš©ëŸ‰ì— ë”°ë¼ ë³€ë™ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤._

## ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ì „ëµ

### 1. ë¸”ë£¨-ê·¸ë¦° ë°°í¬

1. **í˜„ì¬ í™˜ê²½ ìœ ì§€**: Docker Compose í™˜ê²½ ê·¸ëŒ€ë¡œ ìœ ì§€
2. **ìƒˆ í™˜ê²½ êµ¬ì¶•**: ECS/Fargate í™˜ê²½ ì™„ì „íˆ êµ¬ì¶•
3. **íŠ¸ë˜í”½ ì „í™˜**: DNS ë˜ëŠ” ë¡œë“œë°¸ëŸ°ì„œë¥¼ í†µí•´ ì ì§„ì  ì „í™˜
4. **êµ¬ í™˜ê²½ ì •ë¦¬**: ë¬¸ì œì—†ìŒ í™•ì¸ í›„ Docker Compose í™˜ê²½ ì œê±°

### 2. ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

```bash
# ê¸°ì¡´ RabbitMQì—ì„œ ì •ì˜ ë‚´ë³´ë‚´ê¸°
curl -u admin:password123 \
  http://localhost:15672/api/definitions \
  -o rabbitmq-definitions.json

# ìƒˆ í™˜ê²½ìœ¼ë¡œ ì •ì˜ ê°€ì ¸ì˜¤ê¸°
curl -u admin:password123 \
  -H "Content-Type: application/json" \
  -d @rabbitmq-definitions.json \
  -X POST \
  http://[ALB-DNS]/api/definitions
```

## ğŸš¨ ì£¼ì˜ì‚¬í•­

### 1. ë³´ì•ˆ

- **ë¯¼ê°í•œ ì •ë³´**: SSM Parameter Store ì‚¬ìš©
- **ë„¤íŠ¸ì›Œí¬**: í”„ë¼ì´ë¹— ì„œë¸Œë„·ì—ì„œ ì‹¤í–‰
- **ì•”í˜¸í™”**: EFS ì „ì†¡ ì¤‘ ì•”í˜¸í™” í™œì„±í™”

### 2. ê°€ìš©ì„±

- **Multi-AZ**: ì—¬ëŸ¬ ê°€ìš© ì˜ì—­ì— ë¶„ì‚° ë°°ì¹˜
- **Health Checks**: ì ì ˆí•œ í—¬ìŠ¤ì²´í¬ êµ¬ì„±
- **Auto Scaling**: í•„ìš”ì‹œ ì˜¤í† ìŠ¤ì¼€ì¼ë§ ì„¤ì •

### 3. ì„±ëŠ¥

- **ë¦¬ì†ŒìŠ¤ í• ë‹¹**: ì›Œí¬ë¡œë“œì— ë§ëŠ” CPU/ë©”ëª¨ë¦¬ ì„¤ì •
- **ë„¤íŠ¸ì›Œí¬**: Service Discoveryë¥¼ í†µí•œ íš¨ìœ¨ì  í†µì‹ 
- **ìŠ¤í† ë¦¬ì§€**: EFS ì„±ëŠ¥ ëª¨ë“œ ê³ ë ¤

## ğŸ” ëª¨ë‹ˆí„°ë§ ë° ë¡œê·¸

### CloudWatch ëŒ€ì‹œë³´ë“œ ìƒì„±

```bash
# ëŒ€ì‹œë³´ë“œ ìƒì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (ë³„ë„ ì‘ì„± í•„ìš”)
aws cloudwatch put-dashboard \
  --dashboard-name "FishingChat-ECS" \
  --dashboard-body file://cloudwatch-dashboard.json
```

### ë¡œê·¸ í™•ì¸

```bash
# RabbitMQ ë¡œê·¸
aws logs describe-log-streams \
  --log-group-name "/ecs/fishing-chat-rabbitmq"

# Chat API ë¡œê·¸
aws logs describe-log-streams \
  --log-group-name "/ecs/fishing-chat-api"
```

## ğŸ†˜ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ì¼ë°˜ì ì¸ ë¬¸ì œë“¤

1. **RabbitMQ í´ëŸ¬ìŠ¤í„° í˜•ì„± ì‹¤íŒ¨**

   - Erlang ì¿ í‚¤ ì¼ì¹˜ í™•ì¸
   - ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„± í™•ì¸
   - DNS í•´ì„ í™•ì¸

2. **ì„œë¹„ìŠ¤ ì‹œì‘ ì‹¤íŒ¨**

   - CloudWatch ë¡œê·¸ í™•ì¸
   - íƒœìŠ¤í¬ ì •ì˜ ê²€í† 
   - IAM ê¶Œí•œ í™•ì¸

3. **ë¡œë“œë°¸ëŸ°ì„œ ì—°ê²° ì‹¤íŒ¨**
   - í—¬ìŠ¤ì²´í¬ ê²½ë¡œ í™•ì¸
   - ë³´ì•ˆ ê·¸ë£¹ ì„¤ì • í™•ì¸
   - íƒ€ê²Ÿ ê·¸ë£¹ ë“±ë¡ ìƒíƒœ í™•ì¸

### ìœ ìš©í•œ ëª…ë ¹ì–´

```bash
# ECS íƒœìŠ¤í¬ ë¡œê·¸ ì‹¤ì‹œê°„ í™•ì¸
aws logs tail /ecs/fishing-chat-rabbitmq --follow

# ì„œë¹„ìŠ¤ ì´ë²¤íŠ¸ í™•ì¸
aws ecs describe-services \
  --cluster fishing-chat-cluster \
  --services fishing-chat-rabbitmq \
  --query 'services[0].events'

# íƒœìŠ¤í¬ ì‹¤í–‰
aws ecs execute-command \
  --cluster fishing-chat-cluster \
  --task [TASK-ARN] \
  --container rabbitmq \
  --interactive \
  --command "/bin/bash"
```

## ğŸ“ ì§€ì›

ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:

1. CloudWatch ë¡œê·¸
2. ECS ì„œë¹„ìŠ¤ ì´ë²¤íŠ¸
3. ALB íƒ€ê²Ÿ ìƒíƒœ
4. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„±

ì¶”ê°€ ì§€ì›ì´ í•„ìš”í•˜ë©´ ê°œë°œíŒ€ì— ë¬¸ì˜í•˜ì„¸ìš”.
